version: 2.1

orbs:
  win: circleci/windows@2.2.0

jobs:
  core:
    executor:
      name: win/default
      shell: powershell.exe
    steps:
      - checkout
      - restore_cache:
          key: dotnet-packages-{{ checksum "site//DFM.sln" }}
      - run:
          name: dependencies
          command: dotnet.exe restore site/DFM.sln
      - run:
          name: copy_assets
          command: sh .circleci/site/copy_assets.sh
      - save_cache:
          paths:
            - ~/.nuget/packages
          key: dotnet-packages-{{ checksum "site//DFM.sln" }}
      - run:
          name: build
          command: dotnet.exe build -c Debug site/DFM.sln --no-restore
      - run:
          path: site/Tests/Language
          name: tests_language
          command: dotnet.exe test -v m --no-build
      - run:
          path: site/Tests/Email
          name: tests_email
          command: dotnet.exe test -v m --no-build
      - run:
          path: site/Tests/BusinessLogic
          name: tests_business_logic
          command: dotnet.exe test -v m --no-build
      - run:
          path: site/Tests/MVC
          name: tests_mvc
          command: dotnet.exe test -v m --no-build

  site:
    executor:
      name: win/default
      shell: powershell.exe
    steps:
      - checkout
      - run:
          name: create_node_modules
          path: site/Tests/Browser
          command: mkdir node_modules
      - restore_cache:
          key: packages-{{ checksum "site//DFM.sln" }}-{{ checksum "site//Tests//Browser//package.json" }}
      - run:
          name: check_npm_restore
          path: site/Tests/Browser
          command: dir node_modules
      - run:
          name: dependencies_dotnet
          command: dotnet.exe restore site/DFM.sln
      - run:
          name: dependencies_node
          path: site/Tests/Browser
          command: npm install
      - save_cache:
          paths:
            - ~/.nuget/packages
            #- site/Tests/Browser/node_modules
          key: packages-{{ checksum "site//DFM.sln" }}-{{ checksum "site//Tests//Browser//package.json" }}
      - run:
          name: copy_assets
          command: sh .circleci/site/copy_assets.sh
      - run:
          name: publish_site
          path: site/MVC
          command: dotnet.exe publish -c Release MVC.csproj -o ../Tests/Browser/server
      - run:
          name: create_log_folders
          path: site/Tests/Browser
          command: mkdir server/inbox; mkdir log
      - run:
          name: run_site
          path: site/Tests/Browser/server
          command: start DFM.MVC.exe p2709
      - run:
          name: create_contract
          path: site/Tests/Browser
          command: node contract.js
      - run:
          name: tests_browser
          path: site/Tests/Browser
          command: npm test -- --runInBand
      - store_artifacts:
          path: site/Tests/Browser/log
      - store_artifacts:
          path: inbox

  android:
    docker:
      - image: circleci/android:api-28
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "android/build.gradle" }}-{{ checksum "android/DFM/build.gradle" }}
      - run:
          name: runable_gradlew
          path: android
          command: sudo chmod +x gradlew
      - run:
          name: dependencies
          path: android
          command: ./gradlew androidDependencies
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "android/build.gradle" }}-{{ checksum "android/DFM/build.gradle" }}
      - run:
          name: build
          path: android
          command: ./gradlew build -x test
      - run:
          name: tests_android
          path: android
          command: ./gradlew test
      - store_artifacts:
          path: android/DFM/build/reports
          destination: reports
      #- store_test_results:
      #    path: android/DFM/build/test-results

workflows:
  version: 2.1
  build_all:
    jobs:
      - core
      - site
      - android
