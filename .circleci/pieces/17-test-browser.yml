  test_browser:
    docker:
      - image: darakeon/node-chrome
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.11
          docker_layer_caching: true
      - run:
          name: build site machine
          path: architecture/publish
          command: docker build ../.. --progress plain -t dfm-site -f dfm-site.dockerfile
      - run:
          name: run site machine
          path: architecture/publish
          command: |
            docker run -d \
                -e ASPNETCORE_ENVIRONMENT=circleCI \
                -e MSBUILDSINGLELOADCONTEXT=1 \
                -e ASPNETCORE_URLS=http://+:2709 \
                -p 2709:2709
                -v ../../site/Tests/Browser/db:/var/www/db
                -v ../../site/Tests/Browser/log:/var/www/log
                dfm-site
      - restore_cache:
          keys:
            - node-{{ checksum "site/Tests/Browser/package.json" }}-{{ checksum "site/Tests/Browser/package-lock.json" }}
      - run:
          name: tests browser
          command: .circleci/browser/run-tests.sh
      - store_artifacts:
          path: site/Tests/Browser/log
      - store_artifacts:
          path: site/Tests/Browser/db
      - store_artifacts:
          path: outputs/inbox
      - store_artifacts:
          path: outputs/s3

