  change_version:
    docker:
      - image: rust
    resource_class: small
    environment:
      RUST_BACKTRACE: 1
    steps:
      - checkout
      #- attach_workspace:
      #    at: version
      - restore_cache:
          keys:
            - cargo-version-{{ checksum "version/Cargo.toml" }}-{{ checksum "version/Cargo.lock" }}
      - run:
          name: build
          path: version
          command: cargo build
      - run:
          name: version change
          path: version
          command: |
            if [ "$CIRCLE_BRANCH" == "feature/version/new" ]; then
              echo "Already in the new version branch"
            else
              export GIT_EMAIL=$GITHUB_CIRCLE_EMAIL
              export GIT_NAME=$GITHUB_CIRCLE_NAME
              cargo run -q -- -q 1
            fi
      - run:
          name: push
          path: architecture/ci
          command: |
            DIFF=$(git diff origin/$CIRCLE_BRANCH)
            if [ "$DIFF" == "" ]; then
              echo "Nothing to push"
            else
              (type -p wget >/dev/null || (apt update && apt-get install wget -y)) \
                && mkdir -p -m 755 /etc/apt/keyrings \
                      && out=$(mktemp) && wget -nv -O$out https://cli.github.com/packages/githubcli-archive-keyring.gpg \
                      && cat $out | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
                && chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
                && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
                && apt update \
                && apt install gh -y
              source ./config-git
              ./merge-by-branch feature/version/new version
            fi

